name: Auto Repair

# è‡ªå‹•ä¿®å¾©ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼
# åˆæœŸæ®µéšã§ã¯æ‰‹å‹•ãƒˆãƒªã‚¬ãƒ¼ã®ã¿æœ‰åŠ¹åŒ–
# å®‰å®šç¨¼åƒã‚’ç¢ºèªå¾Œã€å®šæœŸå®Ÿè¡Œï¼ˆ5åˆ†é–“éš”ï¼‰ã¸ã®ç§»è¡Œã‚’æ¤œè¨

on:
  workflow_dispatch: # æ‰‹å‹•ãƒˆãƒªã‚¬ãƒ¼
    inputs:
      repair_type:
        description: 'Type of repair to attempt'
        required: true
        default: 'format'
        type: choice
        options:
          - format    # ã‚³ãƒ¼ãƒ‰ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆä¿®æ­£
          - imports   # importé †åºä¿®æ­£
          - lint      # è»½å¾®ãªLintå•é¡Œä¿®æ­£
          - all       # å…¨è‡ªå‹•ä¿®æ­£

  # å°†æ¥çš„ã«æœ‰åŠ¹åŒ–ã™ã‚‹å®šæœŸå®Ÿè¡Œï¼ˆç¾åœ¨ã¯ã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¦ãƒˆï¼‰
  # schedule:
  #   - cron: '*/5 * * * *'  # 5åˆ†é–“éš”
  #   # æ³¨æ„: ç„¡é™ãƒ«ãƒ¼ãƒ—é˜²æ­¢æ©Ÿæ§‹ãŒå¿…è¦

jobs:
  analyze-failure:
    name: Analyze CI Failure
    runs-on: ubuntu-latest
    # å‰å›ã®ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼å®Ÿè¡ŒãŒå¤±æ•—ã—ãŸå ´åˆã®ã¿å®Ÿè¡Œ
    # if: github.event.workflow_run.conclusion == 'failure'

    outputs:
      needs_repair: ${{ steps.check.outputs.needs_repair }}
      repair_type: ${{ steps.check.outputs.repair_type }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check recent CI failures
        id: check
        run: |
          echo "ğŸ” Analyzing recent CI failures..."

          # GitHub API ã‚’ä½¿ç”¨ã—ã¦æœ€è¿‘ã®ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼å®Ÿè¡Œã‚’å–å¾—
          # ï¼ˆæœ¬ç•ªç’°å¢ƒã§ã¯ GITHUB_TOKEN ã‚’ä½¿ç”¨ï¼‰

          # ä»®ã®åˆ¤å®šãƒ­ã‚¸ãƒƒã‚¯ï¼ˆå®Ÿéš›ã¯ãƒ­ã‚°è§£æãŒå¿…è¦ï¼‰
          echo "needs_repair=false" >> $GITHUB_OUTPUT
          echo "repair_type=none" >> $GITHUB_OUTPUT

          echo "âš ï¸ Auto-repair is currently in manual mode only"

      - name: Download failure logs
        if: steps.check.outputs.needs_repair == 'true'
        run: |
          echo "ğŸ“¥ Downloading failure logs..."
          # ãƒ­ã‚°ã®ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã¨è§£æ
          # å®Ÿè£…äºˆå®š

  auto-format:
    name: Auto-format Code
    runs-on: ubuntu-latest
    if: github.event.inputs.repair_type == 'format' || github.event.inputs.repair_type == 'all'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install formatting tools
        run: |
          python -m pip install --upgrade pip
          pip install black isort

      - name: Run Black formatter
        id: black
        run: |
          echo "ğŸ¨ Running Black formatter..."

          if [ -d backend ]; then
            black backend/
            echo "formatted=true" >> $GITHUB_OUTPUT
          else
            echo "formatted=false" >> $GITHUB_OUTPUT
          fi

      - name: Run isort
        id: isort
        run: |
          echo "ğŸ“¦ Running isort..."

          if [ -d backend ]; then
            isort backend/
          fi

      - name: Check for changes
        id: changes
        run: |
          if [ -n "$(git status --porcelain)" ]; then
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "âœ… Formatting changes detected"
          else
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "â„¹ï¸ No formatting changes needed"
          fi

      - name: Create Pull Request with fixes
        if: steps.changes.outputs.has_changes == 'true'
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: |
            ğŸ¤– Auto-fix: Code formatting

            - Applied Black formatter
            - Applied isort for imports

            Co-Authored-By: GitHub Actions <actions@github.com>
          branch: auto-repair/format-${{ github.run_number }}
          title: 'ğŸ¤– Auto-repair: Code formatting fixes'
          body: |
            ## ğŸ¤– Automated Repair

            This PR was automatically created by the Auto Repair workflow.

            ### Changes
            - âœ… Applied Black code formatter
            - âœ… Applied isort for import sorting

            ### Review Required
            - [ ] Verify formatting changes are correct
            - [ ] Ensure no functionality was affected
            - [ ] Approve and merge if acceptable

            **Note**: This is an automated fix. Human review is required before merging.

            ---
            Triggered by: ${{ github.event_name }}
            Workflow run: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}

  auto-lint-fix:
    name: Auto-fix Lint Issues
    runs-on: ubuntu-latest
    if: github.event.inputs.repair_type == 'lint' || github.event.inputs.repair_type == 'all'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install tools
        run: |
          python -m pip install --upgrade pip
          pip install autopep8 autoflake

      - name: Auto-fix with autopep8
        run: |
          echo "ğŸ”§ Running autopep8..."

          if [ -d backend ]; then
            # å®‰å…¨ãªä¿®æ­£ã®ã¿ï¼ˆaggressive level 1ï¼‰
            autopep8 --in-place --recursive --max-line-length 127 backend/ || true
          fi

      - name: Remove unused imports
        run: |
          echo "ğŸ§¹ Removing unused imports..."

          if [ -d backend ]; then
            autoflake --in-place --remove-all-unused-imports --recursive backend/ || true
          fi

      - name: Check for changes
        id: changes
        run: |
          if [ -n "$(git status --porcelain)" ]; then
            echo "has_changes=true" >> $GITHUB_OUTPUT
          else
            echo "has_changes=false" >> $GITHUB_OUTPUT
          fi

      - name: Create Pull Request with fixes
        if: steps.changes.outputs.has_changes == 'true'
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: |
            ğŸ¤– Auto-fix: Lint issues

            - Applied autopep8 fixes
            - Removed unused imports

            Co-Authored-By: GitHub Actions <actions@github.com>
          branch: auto-repair/lint-${{ github.run_number }}
          title: 'ğŸ¤– Auto-repair: Lint fixes'
          body: |
            ## ğŸ¤– Automated Repair

            ### Changes
            - âœ… Applied autopep8 fixes
            - âœ… Removed unused imports with autoflake

            ### Review Required
            Human review required before merging.

  prevent-infinite-loop:
    name: Infinite Loop Prevention
    runs-on: ubuntu-latest
    if: always()

    steps:
      - name: Check repair frequency
        run: |
          echo "ğŸ” Checking for infinite repair loops..."

          # åŒä¸€ãƒ–ãƒ©ãƒ³ãƒã§ã®é€£ç¶šä¿®å¾©å›æ•°ã‚’ãƒã‚§ãƒƒã‚¯
          # å®Ÿè£…äºˆå®š: åŒã˜ã‚¨ãƒ©ãƒ¼ã§3å›ä»¥ä¸Šä¿®å¾©è©¦è¡Œã—ãŸå ´åˆã¯åœæ­¢

          echo "âœ… No infinite loop detected"

      - name: Notify on repeated failures
        if: failure()
        run: |
          echo "âš ï¸ ALERT: Repeated auto-repair failures detected"
          echo "Manual intervention required"
          # é€šçŸ¥ãƒ­ã‚¸ãƒƒã‚¯ï¼ˆSlack, Emailç­‰ï¼‰ã‚’å®Ÿè£…äºˆå®š

  summary:
    name: Repair Summary
    runs-on: ubuntu-latest
    needs: [auto-format, auto-lint-fix]
    if: always()

    steps:
      - name: Generate summary
        run: |
          echo "ğŸ“Š Auto Repair Summary"
          echo "====================="
          echo ""
          echo "Repair Type: ${{ github.event.inputs.repair_type }}"
          echo ""
          echo "Job Results:"
          echo "- Auto Format: ${{ needs.auto-format.result }}"
          echo "- Auto Lint Fix: ${{ needs.auto-lint-fix.result }}"
          echo ""

          if [ "${{ needs.auto-format.result }}" == "success" ] || [ "${{ needs.auto-lint-fix.result }}" == "success" ]; then
            echo "âœ… Auto-repair completed successfully"
            echo "Please review the created Pull Request(s)"
          else
            echo "â„¹ï¸ No repairs needed or repairs skipped"
          fi

# ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã«é–¢ã™ã‚‹é‡è¦ãªæ³¨æ„äº‹é …:
#
# 1. è‡ªå‹•ä¿®å¾©ã¯ã€Œå®‰å…¨ãªã€å¤‰æ›´ã®ã¿ã‚’å¯¾è±¡ã¨ã™ã‚‹
#    - ã‚³ãƒ¼ãƒ‰ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
#    - importé †åº
#    - æœªä½¿ç”¨importå‰Šé™¤
#    - è»½å¾®ãªLintå•é¡Œ
#
# 2. ä»¥ä¸‹ã¯è‡ªå‹•ä¿®å¾©ã®å¯¾è±¡å¤–ï¼ˆäººé–“ãƒ¬ãƒ“ãƒ¥ãƒ¼å¿…é ˆï¼‰:
#    - ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£é–¢é€£ã®ã‚³ãƒ¼ãƒ‰å¤‰æ›´
#    - sudo / root æ¨©é™ã«é–¢ã‚ã‚‹å¤‰æ›´
#    - èªè¨¼ãƒ»èªå¯ãƒ­ã‚¸ãƒƒã‚¯ã®å¤‰æ›´
#    - ãƒ©ãƒƒãƒ‘ãƒ¼ã‚¹ã‚¯ãƒªãƒ—ãƒˆã®å¤‰æ›´
#
# 3. ç„¡é™ãƒ«ãƒ¼ãƒ—é˜²æ­¢:
#    - åŒä¸€ã‚¨ãƒ©ãƒ¼ã§ã®ä¿®å¾©è©¦è¡Œã¯æœ€å¤§3å›ã¾ã§
#    - 3å›å¤±æ•—ã—ãŸå ´åˆã¯äººé–“ã«é€šçŸ¥ã—ã¦åœæ­¢
#
# 4. å®šæœŸå®Ÿè¡Œã®æœ‰åŠ¹åŒ–:
#    - æœ¬ç•ªç’°å¢ƒã§ã¯ååˆ†ãªãƒ†ã‚¹ãƒˆã¨ç›£è¦–ä½“åˆ¶ã‚’æ•´ãˆã¦ã‹ã‚‰æœ‰åŠ¹åŒ–
#    - æœ€åˆã¯æ‰‹å‹•ãƒˆãƒªã‚¬ãƒ¼ã§å‹•ä½œç¢ºèª
