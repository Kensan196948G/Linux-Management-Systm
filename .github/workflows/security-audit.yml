name: Security Audit

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  schedule:
    # ÊØéÈÄ±Êó•ÊõúÊó• 0:00 UTC „Å´ÂÆöÊúüÂÆüË°å
    - cron: '0 0 * * 0'
  workflow_dispatch: # ÊâãÂãï„Éà„É™„Ç¨„Éº„ÇÇÂèØËÉΩ

jobs:
  security-scan:
    name: Comprehensive Security Scan
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install security tools
        run: |
          python -m pip install --upgrade pip
          pip install bandit safety pip-audit

      - name: Run Bandit (Python Security Scanner)
        run: |
          if [ -d backend ]; then
            echo "üîí Running Bandit security scan..."
            bandit -r backend/ -f json -o bandit-full-report.json
            bandit -r backend/ -f screen

            # È´ò„ÉªÈáçÂ§ßÂ∫¶„ÅÆÂïèÈ°å„Çí„ÉÅ„Çß„ÉÉ„ÇØ
            high_severity=$(bandit -r backend/ -f json | jq '[.results[] | select(.issue_severity == "HIGH" or .issue_severity == "CRITICAL")] | length')

            if [ "$high_severity" -gt 0 ]; then
              echo "‚ùå Found $high_severity HIGH/CRITICAL severity issues"
              exit 1
            else
              echo "‚úÖ No HIGH/CRITICAL severity issues found"
            fi
          else
            echo "‚ö†Ô∏è backend/ directory not found - skipping"
          fi

      - name: Check Python dependencies for known vulnerabilities (Safety)
        run: |
          if [ -f backend/requirements.txt ]; then
            echo "üîí Checking dependencies with Safety..."
            pip install -r backend/requirements.txt
            safety check --json || echo "‚ö†Ô∏è Vulnerabilities found in dependencies"
          else
            echo "‚ö†Ô∏è requirements.txt not found - skipping"
          fi

      - name: Audit Python packages (pip-audit)
        run: |
          if [ -f backend/requirements.txt ]; then
            echo "üîí Running pip-audit..."
            pip-audit -r backend/requirements.txt || echo "‚ö†Ô∏è Vulnerabilities found"
          else
            echo "‚ö†Ô∏è requirements.txt not found - skipping"
          fi

  forbidden-patterns:
    name: Forbidden Pattern Detection
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: "CRITICAL: Detect shell=True"
        run: |
          echo "üö® Scanning for shell=True (CRITICAL VIOLATION)..."

          if find backend/ -name "*.py" ! -path "*/docs/*" ! -name "*README.md" ! -name "*CLAUDE.md" -exec grep -l "shell=True" {} \; 2>/dev/null; then
            echo ""
            echo "‚ùå‚ùå‚ùå CRITICAL SECURITY VIOLATION ‚ùå‚ùå‚ùå"
            echo "shell=True detected in the following files:"
            find backend/ -name "*.py" ! -path "*/docs/*" ! -name "*README.md" ! -name "*CLAUDE.md" -exec grep -Hn "shell=True" {} \;
            echo ""
            echo "This is a BLOCKING issue and must be fixed immediately."
            echo "See CLAUDE.md for security principles."
            exit 1
          else
            echo "‚úÖ No shell=True usage detected"
          fi

      - name: "CRITICAL: Detect os.system"
        run: |
          echo "üö® Scanning for os.system (CRITICAL VIOLATION)..."

          if find backend/ -name "*.py" ! -path "*/docs/*" ! -name "*README.md" ! -name "*CLAUDE.md" -exec grep -lE "os\.system\s*\(" {} \; 2>/dev/null; then
            echo ""
            echo "‚ùå‚ùå‚ùå CRITICAL SECURITY VIOLATION ‚ùå‚ùå‚ùå"
            echo "os.system detected in the following files:"
            find backend/ -name "*.py" ! -path "*/docs/*" ! -name "*README.md" ! -name "*CLAUDE.md" -exec grep -HnE "os\.system\s*\(" {} \;
            echo ""
            echo "This is a BLOCKING issue and must be fixed immediately."
            exit 1
          else
            echo "‚úÖ No os.system usage detected"
          fi

      - name: "CRITICAL: Detect eval/exec"
        run: |
          echo "üö® Scanning for eval/exec (CRITICAL VIOLATION)..."

          if find backend/ -name "*.py" ! -path "*/docs/*" ! -name "*README.md" ! -name "*CLAUDE.md" -exec grep -lE "\b(eval|exec)\s*\(" {} \; 2>/dev/null; then
            echo ""
            echo "‚ùå‚ùå‚ùå CRITICAL SECURITY VIOLATION ‚ùå‚ùå‚ùå"
            echo "eval/exec detected in the following files:"
            find backend/ -name "*.py" ! -path "*/docs/*" ! -name "*README.md" ! -name "*CLAUDE.md" -exec grep -HnE "\b(eval|exec)\s*\(" {} \;
            echo ""
            echo "This is a BLOCKING issue and must be fixed immediately."
            exit 1
          else
            echo "‚úÖ No eval/exec usage detected"
          fi

      - name: "CRITICAL: Detect __import__ with user input"
        run: |
          echo "üö® Scanning for dynamic imports (CRITICAL VIOLATION)..."

          if find backend/ -name "*.py" -exec grep -lE "__import__\s*\(" {} \; 2>/dev/null; then
            echo ""
            echo "‚ùå WARNING: Dynamic import detected"
            echo "Please review the following files:"
            find backend/ -name "*.py" -exec grep -HnE "__import__\s*\(" {} \;
            echo ""
            echo "Ensure user input is NOT passed to __import__()"
            # Warning only, manual review required
          else
            echo "‚úÖ No dynamic imports detected"
          fi

      - name: "Detect forbidden special characters in code"
        run: |
          echo "üö® Scanning for dangerous special characters..."

          # Check for unquoted variables in bash scripts
          if find wrappers/ -name "*.sh" -exec grep -E '\$[A-Za-z_]+[^"\}]' {} \; 2>/dev/null | grep -v "^#"; then
            echo ""
            echo "‚ö†Ô∏è WARNING: Potentially unquoted variables in shell scripts"
            echo "All variables in wrappers must be quoted"
            find wrappers/ -name "*.sh" -exec grep -HnE '\$[A-Za-z_]+[^"\}]' {} \; 2>/dev/null | grep -v "^#" || true
          else
            echo "‚úÖ No unquoted variables detected in wrappers"
          fi

      - name: "Detect bash -c in wrappers"
        run: |
          echo "üö® Scanning for bash -c in wrappers (CRITICAL)..."

          if find wrappers/ -name "*.sh" -exec grep -l "bash -c" {} \; 2>/dev/null; then
            echo ""
            echo "‚ùå‚ùå‚ùå CRITICAL SECURITY VIOLATION ‚ùå‚ùå‚ùå"
            echo "bash -c detected in wrappers:"
            find wrappers/ -name "*.sh" -exec grep -Hn "bash -c" {} \;
            echo ""
            echo "Wrappers must use array-based execution only."
            exit 1
          else
            echo "‚úÖ No bash -c usage in wrappers"
          fi

  secrets-scan:
    name: Secrets Detection
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Full history for secret scanning

      - name: Install truffleHog
        run: |
          curl -sSfL https://raw.githubusercontent.com/trufflesecurity/trufflehog/main/scripts/install.sh | sh -s -- -b /usr/local/bin

      - name: Run truffleHog
        run: |
          echo "üîç Scanning for secrets in git history..."
          trufflehog git file://. --only-verified --fail || echo "‚ö†Ô∏è Potential secrets detected - review required"

      - name: Check for common secret patterns
        run: |
          echo "üîç Scanning for common secret patterns..."

          # Check for potential API keys
          if grep -rE "api[_-]?key\s*=\s*['\"][a-zA-Z0-9]{20,}['\"]" . --exclude-dir=.git 2>/dev/null; then
            echo "‚ö†Ô∏è WARNING: Potential API key detected"
            exit 1
          fi

          # Check for potential passwords in code
          if grep -rE "password\s*=\s*['\"][^'\"]{8,}['\"]" backend/ 2>/dev/null; then
            echo "‚ö†Ô∏è WARNING: Hardcoded password detected"
            exit 1
          fi

          echo "‚úÖ No obvious secrets detected"

  sudo-security:
    name: Sudo Security Validation
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Validate wrapper script security
        run: |
          echo "üîí Validating wrapper script security..."

          if [ -d wrappers ]; then
            # Check for set -euo pipefail
            for script in wrappers/*.sh; do
              if [ -f "$script" ]; then
                if ! grep -q "set -euo pipefail" "$script"; then
                  echo "‚ö†Ô∏è WARNING: $script missing 'set -euo pipefail'"
                fi
              fi
            done

            # Check for proper variable quoting
            echo "Checking for proper variable quoting..."

            # Check for input validation
            echo "Checking for input validation..."
            for script in wrappers/*.sh; do
              if [ -f "$script" ]; then
                if ! grep -q "validation\|validate\|check" "$script"; then
                  echo "‚ö†Ô∏è WARNING: $script may be missing input validation"
                fi
              fi
            done
          else
            echo "‚ö†Ô∏è wrappers/ directory not found - skipping"
          fi

  report:
    name: Security Report Summary
    runs-on: ubuntu-latest
    needs: [security-scan, forbidden-patterns, secrets-scan, sudo-security]
    if: always()

    steps:
      - name: Generate security summary
        run: |
          echo "üìä Security Audit Summary"
          echo "========================"
          echo ""
          echo "Job Results:"
          echo "- Security Scan: ${{ needs.security-scan.result }}"
          echo "- Forbidden Patterns: ${{ needs.forbidden-patterns.result }}"
          echo "- Secrets Scan: ${{ needs.secrets-scan.result }}"
          echo "- Sudo Security: ${{ needs.sudo-security.result }}"
          echo ""

          if [ "${{ needs.forbidden-patterns.result }}" == "failure" ]; then
            echo "‚ùå CRITICAL: Forbidden patterns detected"
            echo "This is a BLOCKING security issue."
            exit 1
          fi

          if [ "${{ needs.security-scan.result }}" == "failure" ]; then
            echo "‚ùå High severity security issues detected"
            exit 1
          fi

          echo "‚úÖ Security audit completed"
