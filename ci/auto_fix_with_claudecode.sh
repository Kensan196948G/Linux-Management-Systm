#!/bin/bash
# Claude Code è‡ªå‹•ä¿®å¾©ã‚¹ã‚¯ãƒªãƒ—ãƒˆ
#
# ãƒ“ãƒ«ãƒ‰å¤±æ•—æ™‚ã« Claude Code ã‚’å‘¼ã³å‡ºã—ã¦è‡ªå‹•ä¿®å¾©

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "$SCRIPT_DIR/.." && pwd)"

echo "========================================="
echo "Claude Code - è‡ªå‹•ä¿®å¾©"
echo "========================================="
echo ""

# ãƒ“ãƒ«ãƒ‰ãƒ­ã‚°ã®ç¢ºèª
BUILD_LOG="${BUILD_LOG:-build.log}"

if [ ! -f "$BUILD_LOG" ]; then
    echo "âŒ ãƒ“ãƒ«ãƒ‰ãƒ­ã‚°ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“: $BUILD_LOG"
    exit 1
fi

echo "ðŸ“‹ ãƒ“ãƒ«ãƒ‰ãƒ­ã‚°ã‚’è§£æžä¸­: $BUILD_LOG"
echo ""

# ãƒ­ã‚°ã®å†…å®¹ã‚’è¡¨ç¤ºï¼ˆãƒ‡ãƒãƒƒã‚°ç”¨ï¼‰
echo "--- ãƒ“ãƒ«ãƒ‰ãƒ­ã‚°ï¼ˆæœ€å¾Œã®50è¡Œï¼‰---"
tail -50 "$BUILD_LOG"
echo "--- ãƒ­ã‚°ã“ã“ã¾ã§ ---"
echo ""

# ===================================================================
# Claude Code ã«ä¿®å¾©ã‚’ä¾é ¼
# ===================================================================

echo "ðŸ¤– Claude Code ã«ä¿®å¾©ã‚’ä¾é ¼ä¸­..."
echo ""

# Claude Code ã®ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ä½œæˆ
cat > /tmp/claude_repair_prompt.txt << 'EOF'
ã‚ãªãŸã¯ CI ä¿®ç†å·¥ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã§ã™ã€‚

ä»¥ä¸‹ã®ãƒ“ãƒ«ãƒ‰å¤±æ•—ãƒ­ã‚°ã‚’ç¢ºèªã—ã¦ãã ã•ã„:
---
EOF

cat "$BUILD_LOG" >> /tmp/claude_repair_prompt.txt

cat >> /tmp/claude_repair_prompt.txt << 'EOF'
---

ä¿®å¾©ãƒ«ãƒ¼ãƒ«:
- Python ãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆ.pyï¼‰ã®ã¿ã‚’ä¿®æ­£ã—ã¦ãã ã•ã„
- Shell ã‚¹ã‚¯ãƒªãƒ—ãƒˆï¼ˆ.shï¼‰ã‚‚å¿…è¦ã«å¿œã˜ã¦ä¿®æ­£å¯èƒ½
- ãã®ä»–ã®ãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆ.yml, .md ãªã©ï¼‰ã¯ä¿®æ­£ã—ãªã„ã§ãã ã•ã„
- å·®åˆ†ã¯æœ€å°é™ã«ï¼ˆ1-5è¡Œç¨‹åº¦ï¼‰
- ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°ã¯è¡Œã‚ãªã„
- ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã‚„è¨­è¨ˆã¯å¤‰æ›´ã—ãªã„
- æ–°ã—ã„ä¾å­˜é–¢ä¿‚ã¯è¿½åŠ ã—ãªã„

ã‚¿ã‚¹ã‚¯:
ãƒ“ãƒ«ãƒ‰ãŒæˆåŠŸã™ã‚‹ã‚ˆã†ã€æ ¹æœ¬åŽŸå› ã®ã¿ã‚’ä¿®æ­£ã—ã¦ãã ã•ã„ã€‚
æœ€å°é™ã®å¤‰æ›´ã®ã¿ã‚’é©ç”¨ã—ã¦ãã ã•ã„ã€‚
èª¬æ˜Žã¯ä¸è¦ã§ã™ã€‚ã‚³ãƒ¼ãƒ‰ã®ã¿ä¿®æ­£ã—ã¦ãã ã•ã„ã€‚

ä¿®æ­£ãŒå®Œäº†ã—ãŸã‚‰ã€å¤‰æ›´å†…å®¹ã‚’ç°¡æ½”ã«å ±å‘Šã—ã¦ãã ã•ã„ã€‚
EOF

echo "ðŸ“ ä¿®å¾©ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ:"
cat /tmp/claude_repair_prompt.txt
echo ""
echo "========================================="

# æ³¨æ„: å®Ÿéš›ã® Claude Code å‘¼ã³å‡ºã—ã¯ç’°å¢ƒã«ã‚ˆã£ã¦ç•°ãªã‚‹
# ã“ã“ã§ã¯ã€ä¿®å¾©ãŒå¿…è¦ã§ã‚ã‚‹ã“ã¨ã‚’è¨˜éŒ²ã™ã‚‹ã®ã¿

echo "âš ï¸ æ³¨æ„: Claude Code ã®è‡ªå‹•å‘¼ã³å‡ºã—ã¯æ‰‹å‹•è¨­å®šãŒå¿…è¦ã§ã™"
echo ""
echo "æ‰‹å‹•ã§ä¿®å¾©ã™ã‚‹å ´åˆ:"
echo "  1. ä¸Šè¨˜ã®ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ Claude Code ã«é€ä¿¡"
echo "  2. ä¿®æ­£ã•ã‚ŒãŸã‚³ãƒ¼ãƒ‰ã‚’ç¢ºèª"
echo "  3. git add . && git commit && git push"
echo ""

# ä¿®å¾©ãŒå¿…è¦ã§ã‚ã‚‹ã“ã¨ã‚’ç¤ºã™ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆ
touch .repair_needed

echo "ðŸ“‹ ä¿®å¾©ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ä¿å­˜ã—ã¾ã—ãŸ: /tmp/claude_repair_prompt.txt"
echo "ðŸ“‹ ä¿®å¾©å¿…è¦ãƒ•ãƒ©ã‚°ã‚’ä½œæˆã—ã¾ã—ãŸ: .repair_needed"
echo ""

exit 0
